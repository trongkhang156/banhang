<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quản lý kho - PWA</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{background:#f4f6f8;color:#2d3e50;}
.wrapper{display:flex;flex-direction:column;min-height:100vh;}
.header{background:#27ae60;color:white;text-align:center;font-size:22px;font-weight:700;padding:15px;position:relative;}
.tabs{display:flex;overflow-x:auto;background:#2c3e50;}
.tab{flex:1;padding:12px;color:white;text-align:center;cursor:pointer;transition:0.2s;font-weight:500;}
.tab.active{background:#1e8449;font-weight:700;}
.content{flex:1;padding:15px;}
.card{background:white;padding:15px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08);margin-bottom:15px;}
.card h2{margin-bottom:10px;font-size:18px;color:#34495e;}
form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;}
form input, form select{flex:1 1 120px;padding:10px;border-radius:8px;border:1px solid #cfd4dc;font-size:14px;}
form button{padding:10px 20px;border:none;border-radius:8px;background:#27ae60;color:white;font-weight:600;cursor:pointer;transition:0.2s;}
form button:hover{background:#1e8449;}
table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;margin-top:10px;}
th, td{padding:10px;font-size:14px;border-bottom:1px solid #e5e7eb;text-align:left;}
th{background:#3498db;color:white;font-weight:600;}
tr:hover{background:#f7fbff;}
button{cursor:pointer; border:none; border-radius:6px; padding:6px 12px; background:#27ae60; color:white;}
button:hover{background:#1e8449;}
.delete-btn{background:#e74c3c;color:white;} .delete-btn:hover{background:#c0392b;}
.error-msg{color:red;font-size:13px;margin-top:5px;}
@media (min-width:768px){
  .wrapper{flex-direction:row;}
  .tabs{flex-direction:column;width:180px;height:100vh;}
  .tab{text-align:left;padding-left:20px;}
  .content{flex:1;padding:20px;}
}

/* A2HS button */
#btnAddToHome {
  position:absolute;
  right:15px;
  top:15px;
  background:#f39c12;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  display:none;
  cursor:pointer;
}

/* iOS banner */
#iosBanner {
  display:none;
  background:#f39c12;
  color:white;
  padding:10px;
  text-align:center;
  font-size:14px;
}
</style>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#27ae60">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Quản lý kho">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

</head>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/sw.js")
      .then((reg) => console.log("Service Worker registered", reg))
      .catch((err) => console.log("SW registration failed", err));
  });
}
</script>

<body>

<div id="iosBanner">
  Để cài app: Chạm <strong>Chia sẻ → Thêm vào màn hình chính</strong>
</div>

<div class="header">
  Quản lý kho
  <button id="btnAddToHome">Thêm vào màn hình chính</button>
</div>

<div class="wrapper">
  <div class="tabs">
    <div class="tab active" data-tab="products">Sản phẩm</div>
    <div class="tab" data-tab="inventory">Tồn kho</div>
    <div class="tab" data-tab="import">Phiếu nhập</div>
    <div class="tab" data-tab="export">Phiếu xuất</div>
  </div>

  <div class="content">

    <!-- Products -->
    <div id="products" class="tab-content">
      <div class="card">
        <h2>Thêm sản phẩm</h2>
        <form id="addForm">
          <input type="text" id="addName" placeholder="Tên sản phẩm" required>
          <input type="number" id="addPrice" placeholder="Giá" required>
          <input type="text" id="addDesc" placeholder="Mô tả">
          <button type="submit">Thêm sản phẩm</button>
        </form>
      </div>
      <div class="card">
        <h2>Danh sách sản phẩm</h2>
        <table>
          <thead>
            <tr><th>Tên</th><th>Giá</th><th>Mô tả</th><th>Thao tác</th></tr>
          </thead>
          <tbody id="productTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Inventory -->
    <div id="inventory" class="tab-content" style="display:none;">
      <div class="card">
        <h2>Tồn kho</h2>
        <table>
          <thead><tr><th>Sản phẩm</th><th>Số lượng</th></tr></thead>
          <tbody id="inventoryTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Import -->
    <div id="import" class="tab-content" style="display:none;">
      <div class="card">
        <h2>Phiếu nhập</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <select id="importProduct" style="flex:2"></select>
          <input type="number" id="importQty" placeholder="Số lượng" style="flex:1">
          <button id="addImportItem" style="flex:1">Thêm</button>
        </div>
        <table>
          <thead><tr><th>Sản phẩm</th><th>Số lượng</th><th>Xóa</th></tr></thead>
          <tbody id="importItemsTable"></tbody>
        </table>
        <button id="submitImport" style="margin-top:10px;">Lưu phiếu nhập</button>
      </div>

      <div class="card">
        <h2>Danh sách phiếu nhập</h2>
        <table>
          <thead><tr><th>Mã phiếu</th><th>Chi tiết sản phẩm</th><th>Thao tác</th></tr></thead>
          <tbody id="importReceiptsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Export -->
    <div id="export" class="tab-content" style="display:none;">
      <div class="card">
        <h2>Phiếu xuất</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <select id="exportProduct" style="flex:2"></select>
          <input type="number" id="exportQty" placeholder="Số lượng" style="flex:1">
          <button id="addExportItem" style="flex:1">Thêm</button>
        </div>
        <div class="error-msg" id="exportError"></div>
        <table>
          <thead><tr><th>Sản phẩm</th><th>Số lượng</th><th>Xóa</th></tr></thead>
          <tbody id="exportItemsTable"></tbody>
        </table>
        <button id="submitExport" style="margin-top:10px;">Lưu phiếu xuất</button>
      </div>

      <div class="card">
        <h2>Danh sách phiếu xuất</h2>
        <table>
          <thead><tr><th>Mã phiếu</th><th>Chi tiết sản phẩm</th><th>Thao tác</th></tr></thead>
          <tbody id="exportReceiptsTable"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ========== Tabs ========== */
const tabs=document.querySelectorAll('.tab'); 
const contents=document.querySelectorAll('.tab-content');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
  tabs.forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  contents.forEach(c=>c.style.display=c.id===tab.dataset.tab?'block':'none');
}));

/* ======= A2HS BUTTON (ANDROID) ======= */
let deferredPrompt;
const btnAdd = document.getElementById("btnAddToHome");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnAdd.style.display = "block";
});

btnAdd.addEventListener("click", async () => {
  btnAdd.style.display = "none";
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
});

/* ======= iOS BANNER ======= */
const isIOS = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
const isStandalone = window.navigator.standalone;

if (isIOS && !isStandalone) {
  document.getElementById("iosBanner").style.display = "block";
}

/* ======= REST OF YOUR ORIGINAL JS ======= */

let importItems=[], exportItems=[];

async function loadProducts(){
  const res=await fetch('/api/products'); 
  const data=await res.json();
  const tbody=document.getElementById('productTable'); tbody.innerHTML='';
  const importSel=document.getElementById('importProduct'); importSel.innerHTML='<option value="">Chọn sản phẩm</option>';
  const exportSel=document.getElementById('exportProduct'); exportSel.innerHTML='<option value="">Chọn sản phẩm</option>';
  data.forEach(p=>{
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${p.name}</td><td>${p.price}</td><td>${p.description||''}</td>
                    <td><button onclick="deleteProduct('${p._id}')">Xóa</button></td>`;
    tbody.appendChild(tr);
    const opt1=document.createElement('option'); opt1.value=p._id; opt1.text=p.name; importSel.add(opt1);
    const opt2=document.createElement('option'); opt2.value=p._id; opt2.text=p.name; exportSel.add(opt2);
  });
  loadInventory(); loadInboundReceipts(); loadOutboundReceipts();
}

async function deleteProduct(id){
  if(!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;
  const res = await fetch(`/api/products/${id}`, { method:'DELETE' });
  if(res.ok) loadProducts();
}

async function loadInventory(){
  const res=await fetch('/api/warehouse'); const data=await res.json();
  const tbody=document.getElementById('inventoryTable'); tbody.innerHTML='';
  data.forEach(w=>{
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${w.productId.name}</td><td>${w.stock}</td>`; 
    tbody.appendChild(tr);
  });
}

/* ========== IMPORT ========== */
document.getElementById('addImportItem').addEventListener('click', ()=>{
  const pid=document.getElementById('importProduct').value;
  const qty=+document.getElementById('importQty').value;
  if(!pid||qty<=0) return alert('Chọn sản phẩm và số lượng >0');
  importItems.push({productId:pid, quantity:qty});
  renderImportItems();
});

function renderImportItems(){
  const tbody=document.getElementById('importItemsTable'); tbody.innerHTML='';
  importItems.forEach((it,idx)=>{
    const name=document.getElementById('importProduct').selectedOptions[0].text;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${name}</td><td>${it.quantity}</td>
                  <td><button onclick="importItems.splice(${idx},1);renderImportItems();" class="delete-btn">Xóa</button></td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('submitImport').addEventListener('click', async ()=>{
  if(importItems.length===0) return alert('Chưa có sản phẩm nào');
  const res=await fetch('/api/inbound',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:importItems})});
  if(res.ok){ importItems=[]; renderImportItems(); loadInventory(); loadInboundReceipts(); }
});

/* ========== EXPORT ========== */
document.getElementById('addExportItem').addEventListener('click', ()=>{
  const pid=document.getElementById('exportProduct').value;
  const qty=+document.getElementById('exportQty').value;
  if(!pid||qty<=0) return alert('Chọn sản phẩm và số lượng >0');
  exportItems.push({productId:pid, quantity:qty});
  renderExportItems();
});

function renderExportItems(){
  const tbody=document.getElementById('exportItemsTable'); tbody.innerHTML='';
  exportItems.forEach((it,idx)=>{
    const name=document.getElementById('exportProduct').selectedOptions[0].text;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${name}</td><td>${it.quantity}</td>
                  <td><button onclick="exportItems.splice(${idx},1);renderExportItems();" class="delete-btn">Xóa</button></td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('submitExport').addEventListener('click', async ()=>{
  if(exportItems.length===0) return alert('Chưa có sản phẩm nào');

  const whRes=await fetch('/api/warehouse'); 
  const whData=await whRes.json();

  for(const it of exportItems){
    const stock = whData.find(w=>w.productId._id===it.productId)?.stock||0;
    if(it.quantity>stock) return alert(`Sản phẩm ${it.productId} vượt tồn kho (còn ${stock})`);
  }

  const res=await fetch('/api/outbound',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:exportItems})});
  if(res.ok){ exportItems=[]; renderExportItems(); loadInventory(); loadOutboundReceipts(); }
});

/* LOAD RECEIPTS */
async function loadInboundReceipts(){
  const res=await fetch('/api/inbound'); const data=await res.json();
  const tbody=document.getElementById('importReceiptsTable'); tbody.innerHTML='';
  data.forEach(r=>{
    const items = r.items.map(i=>`${i.productId.name} (${i.quantity})`).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.code}</td><td>${items}</td>
                  <td><button onclick="printReceipt('${r.code}')">In</button>
                      <button onclick="deleteInbound('${r._id}')" class="delete-btn">Xóa</button></td>`;
    tbody.appendChild(tr);
  });
}

async function loadOutboundReceipts(){
  const res=await fetch('/api/outbound'); const data=await res.json();
  const tbody=document.getElementById('exportReceiptsTable'); tbody.innerHTML='';
  data.forEach(r=>{
    const items = r.items.map(i=>`${i.productId.name} (${i.quantity})`).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.code}</td><td>${items}</td>
                  <td><button onclick="printReceipt('${r.code}')">In</button>
                      <button onclick="deleteOutbound('${r._id}')" class="delete-btn">Xóa</button></td>`;
    tbody.appendChild(tr);
  });
}

/* DELETE RECEIPTS */
async function deleteInbound(id){
  if(!confirm('Bạn có chắc muốn xóa phiếu nhập này?')) return;
  const res = await fetch(`/api/inbound/${id}`, { method:'DELETE' });
  if(res.ok) loadInboundReceipts();
}

async function deleteOutbound(id){
  if(!confirm('Bạn có chắc muốn xóa phiếu xuất này?')) return;
  const res = await fetch(`/api/outbound/${id}`, { method:'DELETE' });
  if(res.ok) loadOutboundReceipts();
}

/* PRINT */
function printReceipt(code){
  window.open(`/receipt/${code}`, '_blank');
}

/* ADD PRODUCT */
document.getElementById('addForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const name=document.getElementById('addName').value;
  const price=+document.getElementById('addPrice').value;
  const desc=document.getElementById('addDesc').value;
  await fetch('/api/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,price,description:desc})});
  e.target.reset(); loadProducts();
});

loadProducts();
</script>

</body>
</html>
