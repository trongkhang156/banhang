<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω kho - PWA</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#27ae60">

<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Qu·∫£n l√Ω kho">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{background:#f4f6f8;color:#2d3e50;}
.wrapper{display:flex;flex-direction:column;min-height:100vh;}
.header{background:#27ae60;color:white;text-align:center;font-size:22px;font-weight:700;padding:15px;}
.tabs{display:flex;overflow-x:auto;background:#2c3e50;}
.tab{flex:1;padding:12px;color:white;text-align:center;cursor:pointer;transition:0.2s;font-weight:500;}
.tab.active{background:#1e8449;font-weight:700;}
.content{flex:1;padding:15px;}
.card{background:white;padding:15px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08);margin-bottom:15px;}
.card h2{margin-bottom:10px;font-size:18px;color:#34495e;}
form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;}
form input, form select{flex:1 1 120px;padding:10px;border-radius:8px;border:1px solid #cfd4dc;font-size:14px;}
form button{padding:10px 20px;border:none;border-radius:8px;background:#27ae60;color:white;font-weight:600;cursor:pointer;transition:0.2s;}
form button:hover{background:#1e8449;}
table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;margin-top:10px;}
th, td{padding:10px;font-size:14px;border-bottom:1px solid #e5e7eb;text-align:left;}
th{background:#3498db;color:white;font-weight:600;}
tr:hover{background:#f7fbff;}
button{cursor:pointer; border:none; border-radius:6px; padding:6px 12px; background:#27ae60; color:white;}
button:hover{background:#1e8449;}
.delete-btn{background:#e74c3c;color:white;} .delete-btn:hover{background:#c0392b;}
.error-msg{color:red;font-size:13px;margin-top:5px;}

#installBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #ff9800;
  color: white;
  padding: 12px 18px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: bold;
  display: none;
  z-index: 9999;
}
</style>
</head>

<body>

<button id="installBtn" aria-hidden="true">üì• Th√™m v√†o m√†n h√¨nh ch√≠nh</button>

<div class="header">Qu·∫£n l√Ω kho</div>
<div class="wrapper">
  <div class="tabs">
    <div class="tab active" data-tab="products">S·∫£n ph·∫©m</div>
    <div class="tab" data-tab="inventory">T·ªìn kho</div>
    <div class="tab" data-tab="import">Phi·∫øu nh·∫≠p</div>
    <div class="tab" data-tab="export">Phi·∫øu xu·∫•t</div>
  </div>

  <div class="content">

    <!-- Products -->
    <div id="products" class="tab-content">
      <div class="card">
        <h2>Th√™m s·∫£n ph·∫©m</h2>
        <form id="addForm">
          <input type="text" id="addName" placeholder="T√™n s·∫£n ph·∫©m" required>
          <input type="number" id="addPrice" placeholder="Gi√°" required>
          <input type="text" id="addDesc" placeholder="M√¥ t·∫£">
          <button type="submit">Th√™m s·∫£n ph·∫©m</button>
        </form>
      </div>
      <div class="card">
        <h2>Danh s√°ch s·∫£n ph·∫©m</h2>
        <table>
          <thead>
            <tr><th>T√™n</th><th>Gi√°</th><th>M√¥ t·∫£</th><th>Thao t√°c</th></tr>
          </thead>
          <tbody id="productTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Inventory -->
    <div id="inventory" class="tab-content" style="display:none;">
      <div class="card">
        <h2>T·ªìn kho</h2>
        <table>
          <thead><tr><th>S·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
          <tbody id="inventoryTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Import -->
    <div id="import" class="tab-content" style="display:none;">
      <div class="card">
        <h2>Phi·∫øu nh·∫≠p</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <select id="importProduct" style="flex:2"></select>
          <input type="number" id="importQty" placeholder="S·ªë l∆∞·ª£ng" style="flex:1">
          <button id="addImportItem" style="flex:1">Th√™m</button>
        </div>
        <table>
          <thead><tr><th>S·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>X√≥a</th></tr></thead>
          <tbody id="importItemsTable"></tbody>
        </table>
        <button id="submitImport" style="margin-top:10px;">L∆∞u phi·∫øu nh·∫≠p</button>
      </div>
      <div class="card">
        <h2>Danh s√°ch phi·∫øu nh·∫≠p</h2>
        <table>
          <thead><tr><th>M√£ phi·∫øu</th><th>Chi ti·∫øt</th><th>Thao t√°c</th></tr></thead>
          <tbody id="importReceiptsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Export -->
    <div id="export" class="tab-content" style="display:none;">
      <div class="card">
        <h2>Phi·∫øu xu·∫•t</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <select id="exportProduct" style="flex:2"></select>
          <input type="number" id="exportQty" placeholder="S·ªë l∆∞·ª£ng" style="flex:1">
          <button id="addExportItem" style="flex:1">Th√™m</button>
        </div>
        <div class="error-msg" id="exportError"></div>
        <table>
          <thead><tr><th>S·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>X√≥a</th></tr></thead>
          <tbody id="exportItemsTable"></tbody>
        </table>
        <button id="submitExport" style="margin-top:10px;">L∆∞u phi·∫øu xu·∫•t</button>
      </div>
      <div class="card">
        <h2>Danh s√°ch phi·∫øu xu·∫•t</h2>
        <table>
          <thead><tr><th>M√£ phi·∫øu</th><th>Chi ti·∫øt</th><th>Thao t√°c</th></tr></thead>
          <tbody id="exportReceiptsTable"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
// ========== REGISTER SERVICE WORKER ==========
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js")
    .then(reg => console.log("SW registered:", reg))
    .catch(err => console.log("SW error:", err));
}

// ========== INSTALL BUTTON (Android) ==========
let deferredPrompt;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block";
});

installBtn.addEventListener("click", async () => {
  installBtn.style.display = "none";
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
});

// ========== TABS ==========
const tabs=document.querySelectorAll('.tab');
const contents=document.querySelectorAll('.tab-content');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
  tabs.forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  contents.forEach(c=>c.style.display=c.id===tab.dataset.tab?'block':'none');
}));

// ========== STATE ==========
let importItems = [], exportItems = [];

// ========== LOAD FUNCTIONS (always use no-store) ==========
async function loadProducts(){
  console.log("LOAD PRODUCTS");
  const res = await fetch('/api/products', { cache: "no-store" });
  const data = await res.json();

  const tbody = document.getElementById('productTable');
  tbody.innerHTML = '';

  const importSel = document.getElementById('importProduct');
  importSel.innerHTML = '<option value="">Ch·ªçn s·∫£n ph·∫©m</option>';
  const exportSel = document.getElementById('exportProduct');
  exportSel.innerHTML = '<option value="">Ch·ªçn s·∫£n ph·∫©m</option>';

  data.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(String(p.price))}</td>
      <td>${escapeHtml(p.description||'')}</td>
      <td><button class="btn-delete-product delete-btn" data-id="${p._id}">X√≥a</button></td>
    `;
    tbody.appendChild(tr);

    importSel.add(new Option(p.name, p._id));
    exportSel.add(new Option(p.name, p._id));
  });

  // load dependent lists
  await loadInventory();
  await loadInboundReceipts();
  await loadOutboundReceipts();
}

async function loadInventory(){
  console.log("LOAD INVENTORY");
  const res = await fetch('/api/warehouse', { cache: "no-store" });
  const data = await res.json();

  const tbody = document.getElementById('inventoryTable');
  tbody.innerHTML = '';
  data.forEach(w=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(w.productId.name)}</td><td>${escapeHtml(String(w.stock))}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadInboundReceipts(){
  console.log("LOAD IMPORT RECEIPTS");
  const res = await fetch('/api/inbound', { cache: "no-store" });
  const data = await res.json();

  const tbody = document.getElementById('importReceiptsTable');
  tbody.innerHTML = '';
  data.forEach(r=>{
    const items = r.items.map(i=>`${i.productId.name} (${i.quantity})`).join(', ');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.code)}</td>
      <td>${escapeHtml(items)}</td>
      <td>
        <button class="btn-print" data-code="${escapeHtml(r.code)}">In</button>
        <button class="btn-delete-inbound delete-btn" data-id="${r._id}">X√≥a</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadOutboundReceipts(){
  console.log("LOAD EXPORT RECEIPTS");
  const res = await fetch('/api/outbound', { cache: "no-store" });
  const data = await res.json();

  const tbody = document.getElementById('exportReceiptsTable');
  tbody.innerHTML = '';
  data.forEach(r=>{
    const items = r.items.map(i=>`${i.productId.name} (${i.quantity})`).join(', ');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.code)}</td>
      <td>${escapeHtml(items)}</td>
      <td>
        <button class="btn-print" data-code="${escapeHtml(r.code)}">In</button>
        <button class="btn-delete-outbound delete-btn" data-id="${r._id}">X√≥a</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ========== VISIBILITY (auto-refresh when app resumed) ==========
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    console.log("APP RESUMED ‚Äî reloading");
    loadProducts();
  }
});

// ========== DELETE PRODUCT via delegation ==========
async function deleteProductById(id){
  if(!confirm('X√≥a s·∫£n ph·∫©m?')) return;
  await fetch(`/api/products/${id}`, { method: 'DELETE' });
  await loadProducts();
}

// ========== IMPORT (multi) ==========
document.getElementById('addImportItem').addEventListener('click', ()=>{
  const pid = document.getElementById('importProduct').value;
  const qty = +document.getElementById('importQty').value;
  if(!pid || qty <= 0) return alert('Ch·ªçn s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng >0');
  importItems.push({ productId: pid, quantity: qty });
  renderImportItems();
});

function renderImportItems(){
  const tbody = document.getElementById('importItemsTable');
  tbody.innerHTML = '';
  importItems.forEach((it, idx) => {
    const name = document.getElementById('importProduct').querySelector(`option[value="${it.productId}"]`).text;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(String(it.quantity))}</td>
      <td><button class="btn-remove-import delete-btn" data-idx="${idx}">X√≥a</button></td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('submitImport').addEventListener('click', async ()=>{
  if(importItems.length === 0) return alert('Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o');
  const res = await fetch('/api/inbound', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ items: importItems })
  });
  if (res.ok) {
    alert('Nh·∫≠p kho th√†nh c√¥ng');
    importItems = [];
    renderImportItems();
    await loadProducts(); // reload everything
  } else {
    const err = await res.json().catch(()=>({ error: 'L·ªói server' }));
    alert(err.error || 'L·ªói khi nh·∫≠p kho');
  }
});

// ========== EXPORT (multi) ==========
document.getElementById('addExportItem').addEventListener('click', ()=>{
  const pid = document.getElementById('exportProduct').value;
  const qty = +document.getElementById('exportQty').value;
  if(!pid || qty <= 0) return alert('Ch·ªçn s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng >0');
  exportItems.push({ productId: pid, quantity: qty });
  renderExportItems();
});

function renderExportItems(){
  const tbody = document.getElementById('exportItemsTable');
  tbody.innerHTML = '';
  exportItems.forEach((it, idx) => {
    const name = document.getElementById('exportProduct').querySelector(`option[value="${it.productId}"]`).text;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(String(it.quantity))}</td>
      <td><button class="btn-remove-export delete-btn" data-idx="${idx}">X√≥a</button></td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('submitExport').addEventListener('click', async ()=>{
  if(exportItems.length === 0) return alert('Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o');

  const whRes = await fetch('/api/warehouse', { cache: "no-store" });
  const whData = await whRes.json();

  for(const it of exportItems){
    const stock = whData.find(w => w.productId._id === it.productId)?.stock || 0;
    if(it.quantity > stock) return alert(`Kh√¥ng ƒë·ªß t·ªìn (c√≤n ${stock})`);
  }

  const res = await fetch('/api/outbound', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ items: exportItems })
  });

  if (res.ok) {
    alert('Xu·∫•t kho th√†nh c√¥ng');
    exportItems = [];
    renderExportItems();
    await loadProducts();
  } else {
    const err = await res.json().catch(()=>({ error: 'L·ªói server' }));
    alert(err.error || 'L·ªói khi xu·∫•t kho');
  }
});

// ========== PRINT ==========
function printReceipt(code){
  window.open(`/receipt/${code}`, '_blank');
}

// ========== DELEGATED CLICK HANDLER ==========
document.body.addEventListener('click', async (e) => {
  const t = e.target;

  // delete product
  if (t.classList.contains('btn-delete-product')) {
    const id = t.dataset.id;
    await deleteProductById(id);
    return;
  }

  // remove import item (by index)
  if (t.classList.contains('btn-remove-import')) {
    const idx = Number(t.dataset.idx);
    importItems.splice(idx, 1);
    renderImportItems();
    return;
  }

  // remove export item
  if (t.classList.contains('btn-remove-export')) {
    const idx = Number(t.dataset.idx);
    exportItems.splice(idx, 1);
    renderExportItems();
    return;
  }

  // delete inbound receipt
  if (t.classList.contains('btn-delete-inbound')) {
    const id = t.dataset.id;
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi·∫øu nh·∫≠p?')) return;
    await fetch(`/api/inbound/${id}`, { method: 'DELETE' });
    await loadInboundReceipts();
    await loadProducts();
    return;
  }

  // delete outbound receipt
  if (t.classList.contains('btn-delete-outbound')) {
    const id = t.dataset.id;
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi·∫øu xu·∫•t?')) return;
    await fetch(`/api/outbound/${id}`, { method: 'DELETE' });
    await loadOutboundReceipts();
    await loadProducts();
    return;
  }

  // print button
  if (t.classList.contains('btn-print')) {
    const code = t.dataset.code;
    printReceipt(code);
    return;
  }
});

// ========== ADD PRODUCT ==========
document.getElementById('addForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('addName').value.trim();
  const price = +document.getElementById('addPrice').value;
  const desc = document.getElementById('addDesc').value.trim();

  if (!name) return alert('T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');

  await fetch('/api/products', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ name, price, description: desc })
  });

  e.target.reset();
  await loadProducts();
});

// ========== UTIL ==========
function escapeHtml(str) {
  if (typeof str !== 'string') return str;
  return str.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

// ========== INITIAL LOAD ==========
loadProducts();

</script>

</body>
</html>
